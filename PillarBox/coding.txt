1.	Always compute the MACs on the ciphertext, never on the plaintext.
2.	Use two different keys, one for encryption and one for the MAC.

Rule(1)prevents chosen-ciphertext attacks on block cipher modes such as CBC, since your decryption process can reject those attacker-tampered ciphertexts before theyre even decrypted. Rule(2)deals with the possibility that your MAC and cipher will interact in some unpleasant way.It can also help protect you against side-channel attacks.

This approach  encrypting something, then MACing it  isnot only secure, itsprovablysecureas long as your encryption scheme and MAC have certain properties. Properties that most common schemes do seem to possess. Specifically, your encryption scheme must be IND-CPA secure, which would apply to CBC, CTR, CFB and OFB modes implemented with a secure block cipher. Your MAC must be existentially unforgeable under chosen message attack (EU-CMA), a property thats (believed) to be satisfied by most reasonable instantiations of"http://en.wikipedia.org/wiki/HMAC" HMAC.

"https://blog.cryptographyengineering.com/2012/05/19/how-to-choose-authenticated-encryption/" https://blog.cryptographyengineering.com/2012/05/19/how-to-choose-authenticated-encryption/


Encryption schemes such as AES in CBC mode (non-deterministic) are believed to be semantically secure

"https://www.slideserve.com/austin-foster/querying-encrypted-data" https://www.slideserve.com/austin-foster/querying-encrypted-data


"https://crypto.stackexchange.com/questions/18420/aes-gcm-disadvantage" https://crypto.stackexchange.com/questions/18420/aes-gcm-disadvantage



Password: Super secret password
AES key: C08126FBECA7E2BE71B69FE92570A991
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: EBBECB1D0A5B52F306B0F328877E057A
Message: Now is the time for all good men to come to the aide of their country
Ciphertext+MAC: 880EBA2190A039E94DA2CBBB0F46AA238879D9AE6BD8AFF5E141FF55B4B7D48A3A58B0910DADB9CEF2A7CC7C2954538ABFBF761F9602ED3C1BA8C6C645F96EF48FF9D3ACFA9ABB0C5A4906C00D2C17E9
3CBA8B64D4493B45F7F95C64EB7F947B5C9516AA100E6C02427CF254556DE94C
Recovered: Now is the time for all good men to come to the aide of their country


Ciphertext+MAC: 880EBA2190A039E94DA2CBBB0F46AA238879D9AE6BD8AFF5E141FF55B4B7D48A3A58B0910DADB9CEF2A7CC7C2954538ABFBF761F9602ED3C1BA8C6C645F96EF48FF9D3ACFA9ABB0C5A4906C00D2C17E9
FAEB3E023C23E98613A9D803A04029E81F6D3960EF6A4A101265791CABF00F75


Ciphertext+MAC: 880EBA2190A039E94DA2CBBB0F46AA238879D9AE6BD8AFF5E141FF55B4B7D48A3A58B0910DADB9CEF2A7CC7C2954538ABFBF761F9602ED3C1BA8C6C645F96EF48FF9D3ACFA9ABB0C5A4906C00D2C17E9
D055AB22BE5A33C7837F7ADEDEE53CDA0004786B3337A89C514A16064A1FD43B


Ciphertext+MAC: 880EBA2190A039E94DA2CBBB0F46AA238879D9AE6BD8AFF5E141FF55B4B7D48A3A58B0910DADB9CEF2A7CC7C2954538ABFBF761F9602ED3C1BA8C6C645F96EF48FF9D3ACFA9ABB0C5A4906C00D2C17E9
3A16290CFCDBACD8E78A59EA327E34C05428D0970DBD08AD1B384D63238F404A


five combined modes for confidentiality and authentication (CCM, GCM, KW, KWP, and TKW)
https://csrc.nist.gov/projects/block-cipher-techniques/bcm


---

AES key: C08126FBECA7E2BE71B69FE92570A991
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: EBBECB1D0A5B52F306B0F328877E057A
Message: 1?This is a string
Ciphertext+MAC: AA2E8B702DDB6E9D3455029CE00B79CF5EDA8D155FB417BF9748A88285200FAA4339C999ABF4250CED478B6A2231BA7A8578CDF42A1727ADBD31220B7D3A83B8
Recovered: 1?This is a string

AES key: AA2E8B702DDB6E9D3455029CE00B79CF
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: AA2E8B702DDB6E9D3455029CE00B79CF
Message: 1?This is a string
Ciphertext+MAC: D742C4C9705B8A5FBA0D22429B1E71FF9900F8EE55F20573DF3B1B7A2823B23D54EEF39E05D4B35461BA27105BC56DB0823F02BB5BAF570972CB1E2D3E2725AB
Recovered: 1?This is a string

AES key: D742C4C9705B8A5FBA0D22429B1E71FF
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: D742C4C9705B8A5FBA0D22429B1E71FF
Message: 1?This is a string
Ciphertext+MAC: 72F419334C04AC75DA8762F9577CDD9BE4639D26E6F7ADF11521CDDBA30872EF8EA0D97FC67D1C40D90FD5C39460D3BDFC06F21C89DC0C7342858E990A974859
Recovered: 1?This is a string

AES key: 72F419334C04AC75DA8762F9577CDD9B
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: 72F419334C04AC75DA8762F9577CDD9B
Message: 1?This is a string
Ciphertext+MAC: B8D1B4F29323634A44AE0D5C7EBC675A9E284C1472A2F6350B894817CC5616B4C5B70FC521F233EE03D8C2A76DA18B84D169D8587ED5780FCE4CF8D0694788F0
Recovered: 1?This is a string

AES key: B8D1B4F29323634A44AE0D5C7EBC675A
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: B8D1B4F29323634A44AE0D5C7EBC675A
Message: 2?This is a string
Ciphertext+MAC: BEB54B53DFEA3F4B91027FC594093792CC1A13EA212803240412CFB0352AB73BC7827797152A14CF69065AA2453FE20A809365315B5264CFB16280BBBC6FA32B
Recovered: 2?This is a string

AES key: BEB54B53DFEA3F4B91027FC594093792
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: BEB54B53DFEA3F4B91027FC594093792
Message: 2?This is a string
Ciphertext+MAC: 0A87A2460115CDCA208D3AA524D17B428FEBE31DF81E2D1ED0024ECD68274346CD8C131EDB86D5F6A933750C99119AAAD8AD81A67B1CD8D6C1CD0D0D848ECCEE
Recovered: 2?This is a string

AES key: 0A87A2460115CDCA208D3AA524D17B42
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: 0A87A2460115CDCA208D3AA524D17B42
Message: 2?This is a string
Ciphertext+MAC: A1BABD43D9CE700F14F1B40447DC93EA25B86DE4021B15A46E0FF1EE265D3C5D231F436C53E21796228F09E66DC7A1C73B0B3280BFEE74FF414427C79E6C2FFA
Recovered: 2?This is a string

AES key: A1BABD43D9CE700F14F1B40447DC93EA
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: A1BABD43D9CE700F14F1B40447DC93EA
Message: 2?This is a string
Ciphertext+MAC: 002BE7DCDA0871DE56CB09B3C5E64D6040AE922487E9DA8E81B2C4E9A2D6C325C5787E32A4D84403A0118B2711AA84E22814E7EFC1F81689AFCE37BAB0484DBE
Recovered: 2?This is a string

AES key: 002BE7DCDA0871DE56CB09B3C5E64D60
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: 002BE7DCDA0871DE56CB09B3C5E64D60
Message: 3?This is a string
Ciphertext+MAC: A8FE11B551470BD828B6F718B8BDCC3725C0B7BB66206E193A8E62CAAEA383A34BF8D07803D98CFB2AA01A936AACCC649723C5BB0BF6FC6586E1B7AD347EEC1E
Recovered: 3?This is a string

AES key: A8FE11B551470BD828B6F718B8BDCC37
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: A8FE11B551470BD828B6F718B8BDCC37
Message: 3?This is a string
Ciphertext+MAC: 829C30A8BFA0E1F3100894CDEFDA28ADC65B76EE9FD495A5C928F23387DBADE69E843D4F9B9A2DF1D4EBC4915C1CCD45B19E81FB31458F8CE302DA4914D758AE
Recovered: 3?This is a string

AES key: 829C30A8BFA0E1F3100894CDEFDA28AD
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: 829C30A8BFA0E1F3100894CDEFDA28AD
Message: 3?This is a string
Ciphertext+MAC: 294476176CA6587A71DF7875EFDDB70FA1CACF68EE911FD7087FAE93A41E55B5CA1937BF776A9EDE8C60F951746CE9F8E503C90A3D129DABCAA5792A024783C1
Recovered: 3?This is a string

AES key: 294476176CA6587A71DF7875EFDDB70F
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: 294476176CA6587A71DF7875EFDDB70F
Message: 3?This is a string
Ciphertext+MAC: FD06A21FA304EEC1FA1CC89DFE26A549B4DBB111917EA4080960BB611B2F797030710A97C08AB04A49133D3A2A3C5E80A0AB1E79CD2FE3279731F45A6F2CA8C7
Recovered: 3?This is a string

AES key: FD06A21FA304EEC1FA1CC89DFE26A549
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: FD06A21FA304EEC1FA1CC89DFE26A549
Message: 4?This is a string
Ciphertext+MAC: 33FF5FFE67C2BB68AD06D9F1EACAD9F2F76CA8360BC1EFE6C79B9D0FFF97F8C262755BA23924D72E77C6B247D7516597A5F55EF23F55597F3AFB38397F23E0DA
Recovered: 4?This is a string

AES key: 33FF5FFE67C2BB68AD06D9F1EACAD9F2
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: 33FF5FFE67C2BB68AD06D9F1EACAD9F2
Message: 4?This is a string
Ciphertext+MAC: 585F8BA11FFA57D5BB77AED7F6406E7776A98B9399AA8F3F27980007632F259E17FEDF92F53704F44952CD00B64D873854A7B292D445BB17418F15ADE40B244C
Recovered: 4?This is a string

AES key: 585F8BA11FFA57D5BB77AED7F6406E77
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: 585F8BA11FFA57D5BB77AED7F6406E77
Message: 4?This is a string
Ciphertext+MAC: D14B310B98676ED51C36994827917C50EA18F836A3FAE7BFD5D4C73EE356F4B5A4398CC622A48879FF73D94E7210B573DE894CA37F8C3AC81A9DCBCF58D756C0
Recovered: 4?This is a string

AES key: D14B310B98676ED51C36994827917C50
AES IV: BCEB5407D68912C266B9045A5DD007CB
HMAC key: D14B310B98676ED51C36994827917C50
Message: 4?This is a string
Ciphertext+MAC: EC5E8CB1CCA7F3FCF5A2FC01D56B7D5CBB1A2FA4224AF8811C0B3F756062EC7B059D95D92407472E10008F7D7C372D87DD7767F3CA40B51613EBA09CFD75D212
Recovered: 4?This is a string

Program ended with exit code: 0
